<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libfluidsynth: Using the MIDI sequencer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libfluidsynth
   &#160;<span id="projectnumber">2.2.7</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('Sequencer.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Using the MIDI sequencer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>FluidSynth's sequencer can be used to play MIDI events in a more flexible way than using the MIDI file player, which expects the events to be stored as Standard MIDI Files. Using the sequencer, you can provide the events one by one, with an optional timestamp for scheduling.</p>
<p>The client program should first initialize the sequencer instance using the function <a class="el" href="group__sequencer.html#ga5efba55395b8fbf5f4ed99310a46e6b2" title="Create a new sequencer object. ">new_fluid_sequencer2()</a>. There is a complementary function <a class="el" href="group__sequencer.html#gae9893f73ccea5deddb38cb235b29c6ac" title="Free a sequencer object. ">delete_fluid_sequencer()</a> to delete it. After creating the sequencer instance, the destinations can be registered using <a class="el" href="group__sequencer.html#gaae466e7d4341c9e17bad52c636f1a46d" title="Registers a synthesizer as a destination client of the given sequencer. ">fluid_sequencer_register_fluidsynth()</a> for the synthesizer destination, and optionally using <a class="el" href="group__sequencer.html#ga1a2462a3d4e0dbd963044973ca276e9c" title="Register a sequencer client. ">fluid_sequencer_register_client()</a> for the client destination providing a suitable callback function. It can be unregistered using <a class="el" href="group__sequencer.html#ga9b89c6c0b111d3a96a5dd32c39949e9f" title="Unregister a previously registered client. ">fluid_sequencer_unregister_client()</a>. After the initialization, events can be sent with <a class="el" href="group__sequencer.html#gaa4b59ccf2b12fd52560515b311967081" title="Send an event immediately. ">fluid_sequencer_send_now()</a> and scheduled to the future with <a class="el" href="group__sequencer.html#ga83314f4ad773979841afe50cc2efd83f" title="Schedule an event for sending at a later time. ">fluid_sequencer_send_at()</a>. The registration functions return identifiers, that can be used as destinations of an event using <a class="el" href="group__sequencer__events.html#ga554261a62cfa890262ec26366b35ce8a" title="Set destination of this sequencer event, i.e. ">fluid_event_set_dest()</a>.</p>
<p>The function <a class="el" href="group__sequencer.html#gaf80e738f41f6fc64e5bb8a8e536d1faa" title="Get the current tick of the sequencer scaled by the time scale currently set. ">fluid_sequencer_get_tick()</a> returns the current playing position. A program may choose a new timescale in milliseconds using <a class="el" href="group__sequencer.html#ga7f48dab4cde18da6e0fa76458849c19a" title="Set the time scale of a sequencer. ">fluid_sequencer_set_time_scale()</a>.</p>
<p>The following example uses the fluidsynth sequencer to implement a sort of music box. FluidSynth internal clock is used to schedule repetitive sequences of notes. The next sequence is scheduled on advance before the end of the current one, using a timer event that triggers a callback function. The scheduling times are always absolute values, to avoid slippage.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;fluidsynth.h&quot;</span></div><div class="line"></div><div class="line"><a class="code" href="group__Types.html#gae265f10ae174a13afe010de50d87e1a4">fluid_synth_t</a>* synth;</div><div class="line"><a class="code" href="group__Types.html#gac3706330ce49cac5b7dd079e90d376d8">fluid_audio_driver_t</a>* adriver;</div><div class="line"><a class="code" href="group__Types.html#ga7c7acad4ee620fc954a7ad4d7e87e1c3">fluid_sequencer_t</a>* sequencer;</div><div class="line"><span class="keywordtype">short</span> synthSeqID, mySeqID;</div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> now;</div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> seqduration;</div><div class="line"></div><div class="line"><span class="comment">// prototype</span></div><div class="line"><span class="keywordtype">void</span> seq_callback(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> time, <a class="code" href="group__Types.html#gaca09348be1b6e6ee7fce49dd4734f1ba">fluid_event_t</a>* event, <a class="code" href="group__Types.html#ga7c7acad4ee620fc954a7ad4d7e87e1c3">fluid_sequencer_t</a>* seq, <span class="keywordtype">void</span>* data);</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> createsynth() </div><div class="line">{</div><div class="line">    <a class="code" href="group__Types.html#gaa363402d3c77333b0f070ba531d034ba">fluid_settings_t</a>* settings;</div><div class="line">    settings = <a class="code" href="group__settings.html#ga7623af35fb3d1abace21ef7d5b4f4781">new_fluid_settings</a>();</div><div class="line">    <a class="code" href="group__settings.html#gaec566c035617c2e12de85b82297ac90b">fluid_settings_setint</a>(settings, <span class="stringliteral">&quot;synth.reverb.active&quot;</span>, 0);</div><div class="line">    <a class="code" href="group__settings.html#gaec566c035617c2e12de85b82297ac90b">fluid_settings_setint</a>(settings, <span class="stringliteral">&quot;synth.chorus.active&quot;</span>, 0);</div><div class="line">    synth = <a class="code" href="group__synth.html#ga2aab8e0b82dc9fd086849efacb3c1b1b">new_fluid_synth</a>(settings);</div><div class="line">    adriver = <a class="code" href="group__audio__driver.html#ga7c66ef86f0008807bdd955770fca6925">new_fluid_audio_driver</a>(settings, synth);</div><div class="line">    sequencer = <a class="code" href="group__sequencer.html#ga5efba55395b8fbf5f4ed99310a46e6b2">new_fluid_sequencer2</a>(0);</div><div class="line"></div><div class="line">    <span class="comment">// register synth as first destination</span></div><div class="line">    synthSeqID = <a class="code" href="group__sequencer.html#gaae466e7d4341c9e17bad52c636f1a46d">fluid_sequencer_register_fluidsynth</a>(sequencer, synth);</div><div class="line"></div><div class="line">    <span class="comment">// register myself as second destination</span></div><div class="line">    mySeqID = <a class="code" href="group__sequencer.html#ga1a2462a3d4e0dbd963044973ca276e9c">fluid_sequencer_register_client</a>(sequencer, <span class="stringliteral">&quot;me&quot;</span>, seq_callback, NULL);</div><div class="line"></div><div class="line">    <span class="comment">// the sequence duration, in ms</span></div><div class="line">    seqduration = 1000;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> deletesynth() </div><div class="line">{</div><div class="line">    <a class="code" href="group__sequencer.html#gae9893f73ccea5deddb38cb235b29c6ac">delete_fluid_sequencer</a>(sequencer);</div><div class="line">    <a class="code" href="group__audio__driver.html#ga9c6f54ffa43a8ca482aca81582316f5a">delete_fluid_audio_driver</a>(adriver);</div><div class="line">    <a class="code" href="group__synth.html#gab42ea6e25476be548deb428c839d7d2b">delete_fluid_synth</a>(synth);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> loadsoundfont() </div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> fluid_res;</div><div class="line">    <span class="comment">// put your own path here</span></div><div class="line">    fluid_res = <a class="code" href="group__soundfont__management.html#ga0ba0bc9d4a19c789f9969cd22d22bf66">fluid_synth_sfload</a>(synth, <span class="stringliteral">&quot;Inside:VintageDreamsWaves-v2.sf2&quot;</span>, 1);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> sendnoteon(<span class="keywordtype">int</span> chan, <span class="keywordtype">short</span> key, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> date) </div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> fluid_res;</div><div class="line">    <a class="code" href="group__Types.html#gaca09348be1b6e6ee7fce49dd4734f1ba">fluid_event_t</a> *evt = <a class="code" href="group__sequencer__events.html#ga7d9f4cea7e6421a105641a9b57c6a67d">new_fluid_event</a>();</div><div class="line">    <a class="code" href="group__sequencer__events.html#ga07bf6b85ba0bb7c54eeb2fb9df12c191">fluid_event_set_source</a>(evt, -1);</div><div class="line">    <a class="code" href="group__sequencer__events.html#ga554261a62cfa890262ec26366b35ce8a">fluid_event_set_dest</a>(evt, synthSeqID);</div><div class="line">    <a class="code" href="group__sequencer__events.html#ga75211bc6dd0f268d8b6e502493e96cb2">fluid_event_noteon</a>(evt, chan, key, 127);</div><div class="line">    fluid_res = <a class="code" href="group__sequencer.html#ga83314f4ad773979841afe50cc2efd83f">fluid_sequencer_send_at</a>(sequencer, evt, date, 1);</div><div class="line">    <a class="code" href="group__sequencer__events.html#gae6d14506f08d58b464f24d7b416511b0">delete_fluid_event</a>(evt);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> schedule_next_callback() </div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> fluid_res;</div><div class="line">    <span class="comment">// I want to be called back before the end of the next sequence</span></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> callbackdate = now + seqduration/2;</div><div class="line">    <a class="code" href="group__Types.html#gaca09348be1b6e6ee7fce49dd4734f1ba">fluid_event_t</a> *evt = <a class="code" href="group__sequencer__events.html#ga7d9f4cea7e6421a105641a9b57c6a67d">new_fluid_event</a>();</div><div class="line">    <a class="code" href="group__sequencer__events.html#ga07bf6b85ba0bb7c54eeb2fb9df12c191">fluid_event_set_source</a>(evt, -1);</div><div class="line">    <a class="code" href="group__sequencer__events.html#ga554261a62cfa890262ec26366b35ce8a">fluid_event_set_dest</a>(evt, mySeqID);</div><div class="line">    <a class="code" href="group__sequencer__events.html#ga9468eef722fd23dfa70a4f1619091ecb">fluid_event_timer</a>(evt, NULL);</div><div class="line">    fluid_res = <a class="code" href="group__sequencer.html#ga83314f4ad773979841afe50cc2efd83f">fluid_sequencer_send_at</a>(sequencer, evt, callbackdate, 1);</div><div class="line">    <a class="code" href="group__sequencer__events.html#gae6d14506f08d58b464f24d7b416511b0">delete_fluid_event</a>(evt);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> schedule_next_sequence() {</div><div class="line">    <span class="comment">// Called more or less before each sequence start</span></div><div class="line">    <span class="comment">// the next sequence start date</span></div><div class="line">    now = now + seqduration;</div><div class="line"></div><div class="line">    <span class="comment">// the sequence to play</span></div><div class="line"></div><div class="line">    <span class="comment">// the beat : 2 beats per sequence</span></div><div class="line">    sendnoteon(0, 60, now + seqduration/2);</div><div class="line">    sendnoteon(0, 60, now + seqduration);</div><div class="line"></div><div class="line">    <span class="comment">// melody</span></div><div class="line">    sendnoteon(1, 45, now + seqduration/10);</div><div class="line">    sendnoteon(1, 50, now + 4*seqduration/10);</div><div class="line">    sendnoteon(1, 55, now + 8*seqduration/10);</div><div class="line"></div><div class="line">    <span class="comment">// so that we are called back early enough to schedule the next sequence</span></div><div class="line">    schedule_next_callback();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* sequencer callback */</span></div><div class="line"><span class="keywordtype">void</span> seq_callback(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> time, <a class="code" href="group__Types.html#gaca09348be1b6e6ee7fce49dd4734f1ba">fluid_event_t</a>* event, <a class="code" href="group__Types.html#ga7c7acad4ee620fc954a7ad4d7e87e1c3">fluid_sequencer_t</a>* seq, <span class="keywordtype">void</span>* data) {</div><div class="line">    schedule_next_sequence();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) {</div><div class="line">    createsynth();</div><div class="line">    loadsoundfont();</div><div class="line"></div><div class="line">    <span class="comment">// initialize our absolute date</span></div><div class="line">    now = <a class="code" href="group__sequencer.html#gaf80e738f41f6fc64e5bb8a8e536d1faa">fluid_sequencer_get_tick</a>(sequencer);</div><div class="line">    schedule_next_sequence();</div><div class="line"></div><div class="line">    sleep(100000);</div><div class="line">    deletesynth();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
</body>
</html>
